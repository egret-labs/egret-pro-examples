"use strict";var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);i.prototype=e.prototype,t.prototype=new i},__decorate=this&&this.__decorate||function(t,e,i,s){var r,n=arguments.length,o=3>n?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(3>n?r(o):n>3?r(e,i,o):r(e,i))||o);return n>3&&o&&Object.defineProperty(e,i,o),o},egret3d;!function(t){var e;!function(e){function i(){return t.Vector3.create().release()}function s(t,e){return i().add(t,e)}function r(t,e){return i().subtract(t,e)}function n(t,e){return i().multiplyScalar(e,t)}function o(t,e){return i().cross(t,e)}var a=function(){function a(t,e){this._maxFragmentCount=300,this._points=[],this._pausedTime=-1,this._verticles=[],this._uvs=[],this._colors=[],this._indices=[],this._pointDistances=[0],this._distanceSum=0,this._gameObject=t,this._comp=e,this._onPausedChanged=this._onPausedChanged.bind(this),this._onEmittingChanged=this._onEmittingChanged.bind(this)}return a.prototype.pause=function(){this._pausedTime=paper.clock.timestamp()},a.prototype.initialize=function(){this._comp.onPausedChanged.add(this._onPausedChanged),this._comp.onEmittingChanged.add(this._onEmittingChanged),this._createMesh()},a.prototype.uninitialize=function(){this._comp.onPausedChanged.remove(this._onPausedChanged),this._comp.onEmittingChanged.remove(this._onEmittingChanged),this._releaseMesh()},Object.defineProperty(a.prototype,"gameObject",{get:function(){return this._gameObject},enumerable:!0,configurable:!0}),a.prototype.resume=function(){this._pausedTime<0&&console.warn("_pausedTime should not be less than 0 in TrailBatcher.resume()");for(var t=paper.clock.timestamp()-this._pausedTime,e=0,i=this._points;e<i.length;e++){var s=i[e];s.timeCreated+=t}},a.prototype.update=function(t){if(this._comp){var e=this._comp;if(!e.paused){if(!e.emitting&&e.autoDestruct&&this._points.length<2)return void e.gameObject.destroy();var i=paper.clock.timestamp();this._updateSegments(i),this._rebuildMeshData(i),this._composeMesh()}}},a.prototype._reset=function(){this._points.length=0,this._lastPosition=null,this._pausedTime=-1,this._distanceSum=0,this._pointDistances.length=1,this._resetMeshData()},a.prototype._updateSegments=function(e){var i=this._comp;if(!i.paused){var s=i.transform.position,r=this._lastPosition?s.getDistance(this._lastPosition):-1,n=this._points.length,o=this._points[n-1];if(i.emitting)if(r>i.minVertexDistance||0>r){if(this._points.push({position:t.Vector3.create().copy(s),timeCreated:e}),this._lastPosition||(this._lastPosition=t.Vector3.create()),this._lastPosition.copy(s),o){var a=o.position.getDistance(s);this._pointDistances.push(a),this._distanceSum+=a}}else if(n>0&&(o.position.copy(s),o.timeCreated=e,n>1)){var a=o.position.getDistance(this._points[n-2].position);this._distanceSum=this._distanceSum-this._pointDistances[n-1]+a,this._pointDistances[n-1]=a}this._removeDeadPoints(e,1e3*i.time)}},a.prototype._removeDeadPoints=function(t,e){var i=this._points.length;if(0!==i)for(var s=0;i>s;s++)if(t-this._points[s].timeCreated<e){if(s>0){this._points.splice(0,s);for(var r=0;s>r;r++)this._distanceSum-=this._pointDistances[r];this._pointDistances.splice(0,s)}break}},a.prototype._rebuildMeshData=function(t){this._resetMeshData();var a=this._points.length;if(!(2>a)){var p=this._getCamera();if(p)for(var h=this._comp,c=0,_=h.gameObject.transform.worldToLocalMatrix,u=!1,l=null,d=0;a>d;++d){var m=this._points[d],g=(t-m.timeCreated)/h.time,f=this._getWidthSample(h,g),v=0===d?r(m.position,this._points[d+1].position):r(this._points[d-1].position,m.position),y=h.Alignment===e.TrailAlignment.View?r(p.transform.position,m.position):h.gameObject.transform.getForward(i()),C=o(v,y).normalize();h.autoFlip&&d>0&&l&&l.dot(v)<0&&(u=!u),l=v;var b=s(m.position,n(C,.5*f)).applyMatrix(_),T=s(m.position,n(C,.5*-f)).applyMatrix(_);if(u){var M=b;b=T,T=M}switch(h.textureMode){case e.TrailTextureMode.Stretch:c=this._buildMeshForTextureStretch(b,T,d,c);break;case e.TrailTextureMode.PerSegment:this._buildMeshForTexturePerSegment(b,T,d)}}}},a.prototype._buildMeshForTextureStretch=function(t,e,i,s){var r=6*i;this._verticles[r+0]=t.x,this._verticles[r+1]=t.y,this._verticles[r+2]=t.z,this._verticles[r+3]=e.x,this._verticles[r+4]=e.y,this._verticles[r+5]=e.z;var n=this._distanceSum?this._pointDistances[i]/this._distanceSum:0;if(s+=n,r=4*i,this._uvs[r+0]=s,this._uvs[r+1]=1,this._uvs[r+2]=s,this._uvs[r+3]=0,i>0){r=6*(i-1);var o=2*i;this._indices[r+0]=o-2,this._indices[r+1]=o-1,this._indices[r+2]=o,this._indices[r+3]=o+1,this._indices[r+4]=o,this._indices[r+5]=o-1}return s},a.prototype._buildMeshForTexturePerSegment=function(t,e,i){var s=12*(i-1)+6;this._verticles[s+0]=t.x,this._verticles[s+1]=t.y,this._verticles[s+2]=t.z,this._verticles[s+3]=e.x,this._verticles[s+4]=e.y,this._verticles[s+5]=e.z;var r=8*(i-1)+4,n=i>0?1:0;if(this._uvs[r+0]=n,this._uvs[r+1]=1,this._uvs[r+2]=n,this._uvs[r+3]=0,i>0&&i<this._points.length){i<this._points.length&&(s+=6,this._verticles[s+0]=t.x,this._verticles[s+1]=t.y,this._verticles[s+2]=t.z,this._verticles[s+3]=e.x,this._verticles[s+4]=e.y,this._verticles[s+5]=e.z,r+=4,n=0,this._uvs[r+0]=n,this._uvs[r+1]=1,this._uvs[r+2]=n,this._uvs[r+3]=0);var o=6*(i-1),a=4*(i-1)+2;this._indices[o+0]=a-2,this._indices[o+1]=a-1,this._indices[o+2]=a-0,this._indices[o+3]=a+1,this._indices[o+4]=a-0,this._indices[o+5]=a-1}},a.prototype._getWidthSample=function(t,e){return t.width},a.prototype._getCamera=function(){return t.Camera.main},a.prototype._resetMeshData=function(){this._verticles.length=0,this._uvs.length=0,this._colors.length=0,this._indices.length=0},a.prototype._composeMesh=function(){if(this._points.length>this._maxFragmentCount&&(this._maxFragmentCount=this._points.length,this._createMesh()),this._mesh){var t=this._mesh.getAttributes("POSITION");t&&t.fill(0),this._mesh.setAttributes("POSITION",this._verticles),t=this._mesh.getAttributes("TEXCOORD_0"),t&&t.fill(0),this._mesh.setAttributes("TEXCOORD_0",this._uvs),t=this._mesh.getIndices(),t&&t.fill(0),this._mesh.setIndices(this._indices),this._mesh.uploadVertexBuffer(),this._mesh.uploadSubIndexBuffer(0)}},a.prototype._createMesh=function(){this._mesh=t.Mesh.create(4*(this._maxFragmentCount-1),6*(this._maxFragmentCount-1));var e=this._comp.gameObject.getComponent(t.MeshFilter);return e?void(e.mesh=this._mesh):void console.warn("no MeshFilter on Trail object("+this._comp.gameObject.name+")")},a.prototype._releaseMesh=function(){var e=this._comp.gameObject.getComponent(t.MeshFilter);return e?(e.mesh===this._mesh&&(e.mesh=null),void(this._mesh=null)):void console.warn("no MeshFilter on Trail object("+this._comp.gameObject.name+")")},a.prototype._onPausedChanged=function(){this._comp.paused?this.pause():this.resume()},a.prototype._onEmittingChanged=function(){this._comp.emitting&&this._reset()},a}();e.TrailBatcher=a,__reflect(a.prototype,"egret3d.trail.TrailBatcher")}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var i;!function(t){t.View="View",t.Local="Local"}(i=e.TrailAlignment||(e.TrailAlignment={}));var s;!function(t){t.Stretch="Stretch",t.PerSegment="PerSegment"}(s=e.TrailTextureMode||(e.TrailTextureMode={}));var r=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.time=3,t.minVertexDistance=.1,t.width=1,t.autoDestruct=!1,t.autoFlip=!1,t.Alignment=i.View,t.textureMode=s.Stretch,t.onEmittingChanged=new signals.Signal,t._emitting=!0,t.onPausedChanged=new signals.Signal,t._paused=!1,t}return __extends(r,e),Object.defineProperty(r.prototype,"emitting",{get:function(){return this._emitting},set:function(t){this._emitting!==t&&(this._emitting=t,this.onEmittingChanged.dispatch(t))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"paused",{get:function(){return this._paused},set:function(t){this._paused!==t&&(this._paused=t,this.onPausedChanged.dispatch(t))},enumerable:!0,configurable:!0}),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],r.prototype,"time",void 0),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],r.prototype,"minVertexDistance",void 0),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],r.prototype,"width",void 0),__decorate([paper.serializedField,paper.editor.property("CHECKBOX")],r.prototype,"autoDestruct",void 0),__decorate([paper.serializedField,paper.editor.property("CHECKBOX")],r.prototype,"autoFlip",void 0),__decorate([paper.serializedField,paper.editor.property("LIST",{listItems:paper.editor.getItemsFromEnum(t.trail.TrailAlignment)})],r.prototype,"Alignment",void 0),__decorate([paper.serializedField,paper.editor.property("LIST",{listItems:paper.editor.getItemsFromEnum(t.trail.TrailTextureMode)})],r.prototype,"textureMode",void 0),__decorate([paper.serializedField,paper.editor.property("CHECKBOX")],r.prototype,"emitting",null),__decorate([paper.serializedField,paper.editor.property("CHECKBOX")],r.prototype,"paused",null),r=__decorate([paper.requireComponent(t.MeshFilter),paper.requireComponent(t.MeshRenderer)],r)}(paper.BaseComponent);e.TrailComponent=r,__reflect(r.prototype,"egret3d.trail.TrailComponent")}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){function i(e){var i=t.creater.createGameObject(e);return i.addComponent(t.trail.TrailComponent),i}var s=function(i){function s(){var t=null!==i&&i.apply(this,arguments)||this;return t._batchers=[],t}return __extends(s,i),s.prototype.getMatchers=function(){return[paper.Matcher.create(t.Transform,t.MeshFilter,t.MeshRenderer,e.TrailComponent)]},s.prototype.onEntityAdded=function(t){var i=t.getComponent(e.TrailComponent);if(i){var s=new e.TrailBatcher(t,i);s.initialize(),this._batchers.push(s)}},s.prototype.onEntityRemoved=function(t){for(var e=0;e<this._batchers.length;e++){var i=this._batchers[e];if(i.gameObject===t)return i.uninitialize(),void this._batchers.splice(e,1)}},s.prototype.onFrame=function(t){this._batchers.map(function(e){return e.update(t)})},s}(paper.BaseSystem);e.TrailSystem=s,__reflect(s.prototype,"egret3d.trail.TrailSystem"),e.createTrail=i,paper.Application.systemManager.preRegister(s,paper.Application.gameObjectContext,6999)}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));