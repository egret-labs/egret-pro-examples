"use strict";var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);i.prototype=e.prototype,t.prototype=new i},__decorate=this&&this.__decorate||function(t,e,i,s){var r,n=arguments.length,o=3>n?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(3>n?r(o):n>3?r(e,i,o):r(e,i))||o);return n>3&&o&&Object.defineProperty(e,i,o),o},egret3d;!function(t){var e;!function(e){function i(){return t.Vector3.create().release()}function s(t,e){return i().add(t,e)}function r(t,e){return i().subtract(t,e)}function n(t,e){return i().multiplyScalar(e,t)}function o(t,e){return i().cross(t,e)}var a=function(){function a(){this._maxFragmentCount=300,this._points=[],this._pausedTime=-1,this._verticles=[],this._uvs=[],this._colors=[],this._indices=[],this._pointDistances=[0],this._distanceSum=0}return a.prototype.pause=function(){this._pausedTime=paper.clock.timestamp()},a.prototype.resume=function(){this._pausedTime<0&&console.warn("_pausedTime should not be less than 0 in TrailBatcher.resume()");for(var t=paper.clock.timestamp()-this._pausedTime,e=0,i=this._points;e<i.length;e++){var s=i[e];s.timeCreated+=t}},a.prototype.clean=function(){this._points.length=0,this._lastPosition=null,this._pausedTime=-1,this._distanceSum=0,this._pointDistances.length=1,this._resetMeshData()},a.prototype.init=function(t){this._comp=t,this._createMesh()},a.prototype.update=function(t){if(this._comp){var e=this._comp;if(!e.isPaused){e.isPlaying||e.autoDestruct&&this._points.length<2&&e.gameObject.destroy();var i=paper.clock.timestamp();this._updateSegments(i),this._rebuildMeshData(i),this._composeMesh()}}},a.prototype._updateSegments=function(e){var i=this._comp;if(!i.isPaused){var s=i.transform.position,r=this._lastPosition?s.getDistance(this._lastPosition):-1,n=this._points.length,o=i.isPlaying,a=this._points[n-1];if(o)if(r>i.minVertexDistance||0>r){if(this._points.push({position:t.Vector3.create().copy(s),timeCreated:e}),this._lastPosition||(this._lastPosition=t.Vector3.create()),this._lastPosition.copy(s),a){var p=a.position.getDistance(s);this._pointDistances.push(p),this._distanceSum+=p}}else if(n>0&&(a.position.copy(s),a.timeCreated=e,n>1)){var p=a.position.getDistance(this._points[n-2].position);this._distanceSum=this._distanceSum-this._pointDistances[n-1]+p,this._pointDistances[n-1]=p}this._removeDeadPoints(e,1e3*i.time)}},a.prototype._removeDeadPoints=function(t,e){var i=this._points.length;if(0!==i)for(var s=0;i>s;s++)if(t-this._points[s].timeCreated<e){if(s>0){this._points.splice(0,s);for(var r=0;s>r;r++)this._distanceSum-=this._pointDistances[r];this._pointDistances.splice(0,s)}break}},a.prototype._rebuildMeshData=function(t){this._resetMeshData();var a=this._points.length;if(!(2>a)){var p=this._getCamera();if(p)for(var h=this._comp,c=0,_=h.gameObject.transform.worldToLocalMatrix,l=0;a>l;++l){var u=this._points[l],m=(t-u.timeCreated)/h.time,d=this._getWidthSample(h,m),f=0===l?r(u.position,this._points[l+1].position):r(this._points[l-1].position,u.position),g=h.Alignment===e.TrailAlignment.View?r(p.transform.position,u.position):h.gameObject.transform.getForward(i()),y=o(f,g).normalize(),v=void 0;if(v=s(u.position,n(y,.5*d)),v.applyMatrix(_),this._verticles[6*l+0]=v.x,this._verticles[6*l+1]=v.y,this._verticles[6*l+2]=v.z,v=s(u.position,n(y,.5*-d)),v.applyMatrix(_),this._verticles[6*l+3]=v.x,this._verticles[6*l+4]=v.y,this._verticles[6*l+5]=v.z,h.textureMode===e.TrailTextureMode.Stretch){var T=this._distanceSum?this._pointDistances[l]/this._distanceSum:0;c+=T,this._uvs[4*l+0]=c,this._uvs[4*l+1]=1,this._uvs[4*l+2]=c,this._uvs[4*l+3]=0}else this._uvs[2*l+0]=0,this._uvs[2*l+1]=1,this._uvs[2*l+0]=0,this._uvs[2*l+1]=0;l>0&&(this._indices[6*(l-1)+0]=2*l-2,this._indices[6*(l-1)+1]=2*l-1,this._indices[6*(l-1)+2]=2*l,this._indices[6*(l-1)+3]=2*l+1,this._indices[6*(l-1)+4]=2*l,this._indices[6*(l-1)+5]=2*l-1)}}},a.prototype._getWidthSample=function(t,e){return t.width},a.prototype._getCamera=function(){return t.Camera.main},a.prototype._resetMeshData=function(){this._verticles.length=0,this._uvs.length=0,this._colors.length=0,this._indices.length=0},a.prototype._composeMesh=function(){this._points.length>this._maxFragmentCount&&(this._maxFragmentCount=this._points.length,this._createMesh());var e=this._comp.gameObject.getComponent(t.MeshFilter);if(!e)return void console.warn("no MeshFilter on Trail object("+this._comp.gameObject.name+")");e.mesh=this._mesh;var i=this._mesh.getAttributes("POSITION");i&&i.fill(0),this._mesh.setAttributes("POSITION",this._verticles),i=this._mesh.getAttributes("TEXCOORD_0"),i&&i.fill(0),this._mesh.setAttributes("TEXCOORD_0",this._uvs),i=this._mesh.getIndices(),i&&i.fill(0),this._mesh.setIndices(this._indices),this._mesh.uploadVertexBuffer(),this._mesh.uploadSubIndexBuffer(0)},a.prototype._createMesh=function(){this._mesh=t.Mesh.create(4*this._maxFragmentCount,6*(this._maxFragmentCount-1))},a}();e.TrailBatcher=a,__reflect(a.prototype,"egret3d.trail.TrailBatcher")}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var i;!function(t){t.View="View",t.Local="Local"}(i=e.TrailAlignment||(e.TrailAlignment={}));var s;!function(t){t.Stretch="Stretch",t.PerSegment="PerSegment",t.Tile="Tile"}(s=e.TrailTextureMode||(e.TrailTextureMode={}));var r=function(r){function n(){var t=null!==r&&r.apply(this,arguments)||this;return t.time=3,t.minVertexDistance=.1,t.width=1,t.autoDestruct=!1,t.Alignment=i.View,t.textureMode=s.Stretch,t._isPlaying=!0,t._isPaused=!1,t._timeScale=1,t._batcher=new e.TrailBatcher,t}return __extends(n,r),n.prototype._clean=function(){this._batcher.clean()},n.prototype.initialize=function(){r.prototype.initialize.call(this),this._batcher.init(this),this._clean()},n.prototype.uninitialize=function(){r.prototype.uninitialize.call(this),this._clean()},n.prototype.update=function(t){this._batcher.update(t*this._timeScale)},n.prototype.play=function(){this._isPlaying=!0,this._isPaused=!1,this._batcher.clean()},n.prototype.resume=function(){if(this._isPaused)this._isPaused=!1,this._batcher.resume();else{if(this._isPlaying)return;this.play()}},n.prototype.pause=function(){this._isPlaying&&(this._isPaused=!0)},n.prototype.stop=function(){this._isPlaying=!1,this._isPaused=!1},Object.defineProperty(n.prototype,"isPlaying",{get:function(){return this._isPlaying},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPaused",{get:function(){return this._isPaused},enumerable:!0,configurable:!0}),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],n.prototype,"time",void 0),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],n.prototype,"minVertexDistance",void 0),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],n.prototype,"width",void 0),__decorate([paper.serializedField,paper.editor.property("CHECKBOX")],n.prototype,"autoDestruct",void 0),__decorate([paper.serializedField,paper.editor.property("LIST",{listItems:paper.editor.getItemsFromEnum(t.trail.TrailAlignment)})],n.prototype,"Alignment",void 0),__decorate([paper.serializedField],n.prototype,"textureMode",void 0),n=__decorate([paper.requireComponent(t.MeshFilter),paper.requireComponent(t.MeshRenderer)],n)}(paper.BaseComponent);e.TrailComponent=r,__reflect(r.prototype,"egret3d.trail.TrailComponent")}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){function i(e){var i=t.creater.createGameObject(e);return i.addComponent(t.trail.TrailComponent),i}var s=function(i){function s(){return null!==i&&i.apply(this,arguments)||this}return __extends(s,i),s.prototype.getMatchers=function(){return[paper.Matcher.create(t.Transform,t.MeshFilter,t.MeshRenderer,e.TrailComponent)]},s.prototype.onFrame=function(t){for(var i=0,s=this.groups[0].entities;i<s.length;i++){var r=s[i],n=r.getComponent(e.TrailComponent);n&&n.update(t)}},s}(paper.BaseSystem);e.TrailSystem=s,__reflect(s.prototype,"egret3d.trail.TrailSystem"),e.createTrail=i,paper.Application.systemManager.preRegister(s,paper.Application.gameObjectContext,6999)}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));